<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daya Tampung & Peluang SNBT (dengan Analisis AI)</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


  <style>
    /* Menggunakan font Inter sebagai default */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc; /* slate-50 */
    }
    /* Style untuk scrollbar agar lebih minimalis */
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    /* Style untuk disabled button */
    button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
    /* Animasi untuk modal */
    .modal-enter {
        opacity: 0;
        transform: scale(0.95);
    }
    .modal-enter-active {
        opacity: 1;
        transform: scale(1);
        transition: opacity 300ms, transform 300ms;
    }
    .modal-leave {
        opacity: 1;
        transform: scale(1);
    }
    .modal-leave-active {
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 300ms, transform 300ms;
    }
    /* Spinner animation */
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    .spinner {
        border-color: #4A90E2 transparent #4A90E2 transparent;
        animation: spin 1.2s linear infinite;
    }
  </style>
</head>

<body class="text-slate-800">

  <!-- Header / Navbar -->
  <header class="bg-white shadow-md sticky top-0 z-40">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <div class="flex-shrink-0 flex items-center space-x-2">
          <i class="fas fa-graduation-cap text-blue-600 text-2xl"></i>
          <a href="#" class="text-2xl font-bold text-slate-700 hover:text-blue-600 transition-colors">
            Info SNBT
          </a>
        </div>
        <div class="hidden md:block">
          <div class="ml-10 flex items-baseline space-x-4">
            <a href="#" class="bg-blue-50 text-blue-700 px-3 py-2 rounded-md text-sm font-medium" aria-current="page">Home</a>
            <a href="#" class="text-slate-500 hover:bg-slate-100 hover:text-slate-900 px-3 py-2 rounded-md text-sm font-medium">Tentang</a>
            <a href="#" class="text-slate-500 hover:bg-slate-100 hover:text-slate-900 px-3 py-2 rounded-md text-sm font-medium">Kontak</a>
          </div>
        </div>
        <!-- Tombol Hamburger untuk Mobile -->
        <div class="-mr-2 flex md:hidden">
          <button type="button" id="mobile-menu-button" class="bg-white inline-flex items-center justify-center p-2 rounded-md text-slate-400 hover:text-slate-500 hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-controls="mobile-menu" aria-expanded="false">
            <span class="sr-only">Buka menu utama</span>
            <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            <svg class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
      </div>
    </nav>
    <!-- Menu Mobile -->
    <div class="md:hidden hidden" id="mobile-menu">
      <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
        <a href="#" class="bg-blue-50 text-blue-700 block px-3 py-2 rounded-md text-base font-medium" aria-current="page">Home</a>
        <a href="#" class="text-slate-500 hover:bg-slate-100 hover:text-slate-900 block px-3 py-2 rounded-md text-base font-medium">Tentang</a>
        <a href="#" class="text-slate-500 hover:bg-slate-100 hover:text-slate-900 block px-3 py-2 rounded-md text-base font-medium">Kontak</a>
      </div>
    </div>
  </header>

  <!-- Konten Utama -->
  <main class="container mx-auto p-4 sm:p-6 lg:p-8">
    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg space-y-6">
      
      <!-- Judul dan Deskripsi -->
      <div>
          <h1 class="text-2xl sm:text-3xl font-bold text-slate-800">Data Daya Tampung & Peluang Lolos SNBT</h1>
          <p class="mt-2 text-slate-500">Gunakan pencarian untuk menemukan data PTN dan dapatkan <span class="font-semibold text-blue-600">analisis AI</span> untuk strategi Anda.</p>
      </div>

      <!-- Pesan Informasi -->
      <div id="info-alert" class="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 rounded-r-lg flex justify-between items-center" role="alert">
        <p class="text-sm">Data diambil dari laman resmi <a href="https://sidata-ptn-snpmb.bppp.kemdikbud.go.id/ptn_sb.php" class="font-medium underline hover:text-amber-900" title="Kementerian" target="_blank" rel="noopener noreferrer">KEMDIKBUD</a>.</p>
        <button type="button" class="ml-4" aria-label="Close" onclick="document.getElementById('info-alert').style.display='none'"><i class="fas fa-times text-amber-600 hover:text-amber-800"></i></button>
      </div>

      <!-- Kotak Pencarian -->
      <div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search text-slate-400"></i></div><input type="text" id="searchInput" class="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg bg-white placeholder-slate-500 focus:outline-none focus:placeholder-slate-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition" placeholder="Cari berdasarkan nama PTN..."></div>
      
      <!-- Kontainer untuk Loading dan Tabel -->
      <div id="data-container">
          <div id="loadingIndicator" class="text-center py-10 flex flex-col items-center"><div class="spinner w-8 h-8 rounded-full border-4"></div><p class="mt-3 text-slate-500">Memuat data...</p></div>
          <div id="universityData" class="custom-scrollbar overflow-x-auto hidden"></div>
          <div id="noResults" class="text-center py-10 hidden"><p class="text-slate-500">Data tidak ditemukan.</p></div>
      </div>

      <!-- Tombol Navigasi -->
      <div id="paginationControls" class="flex justify-between items-center mt-6 hidden">
        <button id="prevBtn" class="inline-flex items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 transition"><i class="fas fa-arrow-left mr-2"></i>Sebelumnya</button>
        <span id="pageInfo" class="text-sm text-slate-600"></span>
        <button id="nextBtn" class="inline-flex items-center px-4 py-2 border border-slate-300 text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 transition">Selanjutnya<i class="fas fa-arrow-right ml-2"></i></button>
      </div>
    </div>
  </main>
  
  <!-- Modal AI Analysis -->
  <div id="aiModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-enter">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
      <div class="p-5 border-b border-slate-200 flex justify-between items-center">
        <h2 class="text-xl font-bold text-slate-800 flex items-center"><i class="fas fa-robot text-blue-500 mr-3"></i>Analisis AI & Rekomendasi</h2>
        <button id="closeModalBtn" class="text-slate-400 hover:text-slate-600 transition-colors"><i class="fas fa-times fa-lg"></i></button>
      </div>
      <div id="modalContent" class="p-6 space-y-6 overflow-y-auto">
        <!-- Loading state -->
        <div id="modalLoading" class="text-center py-12">
            <div class="spinner w-10 h-10 rounded-full border-4 mx-auto"></div>
            <p class="mt-4 text-slate-600">Gemini sedang menganalisis data, mohon tunggu...</p>
        </div>
        <!-- Result state -->
        <div id="modalResult" class="hidden">
            <div class="bg-slate-50 p-4 rounded-lg">
                <h3 class="font-bold text-lg text-slate-700" id="modalTitle"></h3>
                <p class="text-sm text-slate-500" id="modalSubtitle"></p>
            </div>
            <div id="aiResponse" class="prose prose-sm max-w-none mt-4 text-slate-700"></div>
        </div>
      </div>
      <div class="p-4 bg-slate-50 border-t border-slate-200 text-center text-xs text-slate-500 rounded-b-xl">
        Analisis ini dibuat oleh AI dan mungkin mengandung ketidakakuratan. Selalu lakukan riset mandiri.
      </div>
    </div>
  </div>


  <!-- Footer -->
  <footer class="text-center mt-8 pb-6"><p class="text-sm text-slate-500">&copy; 2024 DivaArvian. Didesain ulang & ditenagai oleh AI. All rights reserved.</p></footer>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');
      mobileMenuButton.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
        mobileMenuButton.querySelectorAll('svg').forEach(icon => icon.classList.toggle('hidden'));
      });

      const calculateKeketatan = (peminat, tampung) => {
        if (peminat === 0 || tampung === 0 || !peminat || !tampung) return 'N/A';
        return ((tampung / peminat) * 100).toFixed(2) + '%';
      };

      const url = 'https://divarvian.github.io/daya-tampung/result_data.json';

      const universityDiv = document.getElementById('universityData');
      const searchInput = document.getElementById('searchInput');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const noResults = document.getElementById('noResults');
      const paginationControls = document.getElementById('paginationControls');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');
      
      // AI Modal elements
      const aiModal = document.getElementById('aiModal');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const modalContent = document.getElementById('modalContent');
      const modalLoading = document.getElementById('modalLoading');
      const modalResult = document.getElementById('modalResult');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubtitle = document.getElementById('modalSubtitle');
      const aiResponse = document.getElementById('aiResponse');


      let universities = {};
      let allProdiData = [];
      let filteredData = [];
      let currentPage = 0;
      const pageSize = 5;

      fetch(url)
        .then(response => response.ok ? response.json() : Promise.reject(`HTTP error! status: ${response.status}`))
        .then(data => {
          let lastYear = 0;
          data.forEach(item => {
            const universityName = item.namaPTN;
            if (!universities[universityName]) universities[universityName] = [];

            Object.entries(item.programStudi).forEach(([jenjang, prodiData]) => {
              Object.entries(prodiData).forEach(([prodiName, tahunData]) => {
                const prodi = { ptn: universityName, programStudi: prodiName, jenjang, jumlahPeminat: {}, dayaTampung: {} };
                let yearsInProdi = Object.keys(tahunData).filter(y => !isNaN(y));
                yearsInProdi.forEach(year => {
                    prodi.jumlahPeminat[year] = tahunData[year].jumlahPeminat;
                    prodi.dayaTampung[year] = tahunData[year].dayaTampung;
                    lastYear = Math.max(lastYear, parseInt(year));
                });
                prodi.jumlahPeminat[lastYear.toString()] = "NYK";
                const prevYear = (lastYear - 1).toString();
                prodi.keketatan = calculateKeketatan(tahunData[prevYear]?.jumlahPeminat, tahunData[prevYear]?.dayaTampung);
                universities[universityName].push(prodi);
                allProdiData.push(prodi);
              });
            });
          });
          
          loadingIndicator.style.display = 'none';
          universityDiv.classList.remove('hidden');
          paginationControls.classList.remove('hidden');
          filterAndRender();
        })
        .catch(error => {
          console.error('Error fetching data:', error);
          loadingIndicator.innerHTML = '<p class="text-red-500">Gagal memuat data. Silakan coba lagi nanti.</p>';
        });

      const renderTable = () => {
        universityDiv.innerHTML = '';
        noResults.classList.add('hidden');

        if (filteredData.length === 0) {
            noResults.classList.remove('hidden');
            paginationControls.classList.add('hidden');
            return;
        } else {
            paginationControls.classList.remove('hidden');
        }

        const table = document.createElement('table');
        table.className = 'w-full text-sm text-left text-slate-500';

        const uniqueYears = new Set();
        allProdiData.forEach(prodi => Object.keys(prodi.jumlahPeminat).forEach(year => !isNaN(year) && uniqueYears.add(year)));
        const sortedYears = [...uniqueYears].sort((a, b) => a - b);
        const lastYear = sortedYears[sortedYears.length - 1];

        table.innerHTML = `
          <thead class="text-xs text-slate-700 uppercase bg-slate-100">
            <tr>
              <th scope="col" rowspan="2" class="px-6 py-3 whitespace-nowrap sticky left-0 bg-slate-100">Perguruan Tinggi Negeri</th>
              <th scope="col" rowspan="2" class="px-6 py-3 whitespace-nowrap">Program Studi</th>
              <th scope="col" rowspan="2" class="px-6 py-3">Jenjang</th>
              ${sortedYears.map(year => `<th scope="col" colspan="2" class="px-6 py-3 text-center">${year}</th>`).join('')}
              <th scope="col" rowspan="2" class="px-6 py-3 text-center whitespace-nowrap">Peluang (${lastYear-1})</th>
              <th scope="col" rowspan="2" class="px-6 py-3 text-center">Aksi</th>
            </tr>
            <tr>
              ${sortedYears.map(() => `<th scope="col" class="px-4 py-3 text-center whitespace-nowrap">Peminat</th><th scope="col" class="px-4 py-3 text-center whitespace-nowrap">D. Tampung</th>`).join('')}
            </tr>
          </thead>`;

        const tableBody = document.createElement('tbody');
        const startIndex = currentPage * pageSize;
        const endIndex = startIndex + pageSize;
        const pageData = filteredData.slice(startIndex, endIndex);

        pageData.forEach(([universityName, prodiArray]) => {
          prodiArray.forEach((prodi, index) => {
            const row = tableBody.insertRow();
            row.className = 'bg-white border-b hover:bg-slate-50';
            
            let rowHTML = '';
            if (index === 0) {
              rowHTML += `<td rowspan="${prodiArray.length}" class="px-6 py-4 font-bold text-slate-900 align-top whitespace-nowrap sticky left-0 bg-white group-hover:bg-slate-50">${universityName}</td>`;
            }
            rowHTML += `<td class="px-6 py-4 font-medium text-slate-800">${prodi.programStudi}</td>`;
            rowHTML += `<td class="px-6 py-4 text-center">${prodi.jenjang}</td>`;
            
            sortedYears.forEach(year => {
              const peminat = prodi.jumlahPeminat[year] || 'N/A';
              const tampung = prodi.dayaTampung[year] || 'N/A';
              rowHTML += `<td class="px-4 py-4 text-center">${peminat}</td><td class="px-4 py-4 text-center text-green-600 font-semibold">${tampung}</td>`;
            });

            rowHTML += `<td class="px-6 py-4 text-center font-bold ${prodi.keketatan === 'N/A' ? 'text-slate-500' : 'text-blue-600'}">${prodi.keketatan}</td>`;
            rowHTML += `
                <td class="px-6 py-4 text-center">
                    <button class="ai-analysis-btn bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold px-3 py-1.5 rounded-md hover:from-blue-600 hover:to-indigo-700 shadow-sm hover:shadow-md transition-all text-xs" data-prodi='${JSON.stringify(prodi)}'>
                        ✨ Analisis AI
                    </button>
                </td>`;
            row.innerHTML = rowHTML;
          });
        });
        
        table.appendChild(tableBody);
        universityDiv.appendChild(table);
        updatePagination();
      };

      const updatePagination = () => {
        const totalPages = Math.ceil(filteredData.length / pageSize);
        pageInfo.textContent = `Halaman ${currentPage + 1} dari ${totalPages || 1}`;
        prevBtn.disabled = currentPage === 0;
        nextBtn.disabled = currentPage >= totalPages - 1;
      };

      const filterAndRender = () => {
        const searchTerm = searchInput.value.toLowerCase();
        filteredData = Object.entries(universities).filter(([universityName]) => universityName.toLowerCase().includes(searchTerm));
        currentPage = 0;
        renderTable();
      };
      
      prevBtn.addEventListener('click', () => { if (currentPage > 0) { currentPage--; renderTable(); } });
      nextBtn.addEventListener('click', () => { const totalPages = Math.ceil(filteredData.length / pageSize); if (currentPage < totalPages - 1) { currentPage++; renderTable(); } });
      searchInput.addEventListener('input', filterAndRender);

      // AI Modal Logic
      function showModal() {
        aiModal.classList.remove('hidden');
        setTimeout(() => aiModal.classList.add('modal-enter-active'), 10);
      }

      function hideModal() {
        aiModal.classList.remove('modal-enter-active');
        setTimeout(() => aiModal.classList.add('hidden'), 300);
      }
      
      closeModalBtn.addEventListener('click', hideModal);
      aiModal.addEventListener('click', (e) => { if(e.target === aiModal) hideModal(); });
      
      universityDiv.addEventListener('click', async (e) => {
        if (e.target.classList.contains('ai-analysis-btn')) {
            const prodiData = JSON.parse(e.target.dataset.prodi);
            
            showModal();
            modalResult.classList.add('hidden');
            modalLoading.classList.remove('hidden');
            
            modalTitle.textContent = prodiData.programStudi;
            modalSubtitle.textContent = prodiData.ptn;

            // Prepare data for prompt
            let history = "";
            const years = Object.keys(prodiData.dayaTampung).sort((a,b) => b-a);
            years.forEach(year => {
                history += `- Tahun ${year}: Peminat ${prodiData.jumlahPeminat[year] || 'N/A'}, Daya Tampung ${prodiData.dayaTampung[year] || 'N/A'}\n`;
            });

            const prompt = `
Anda adalah seorang konsultan ahli masuk perguruan tinggi di Indonesia. Berikan analisis untuk calon mahasiswa yang tertarik pada program studi berikut:

**Program Studi:** ${prodiData.programStudi}
**Perguruan Tinggi:** ${prodiData.ptn}
**Jenjang:** ${prodiData.jenjang}

**Data Historis:**
${history}
**Tingkat Peluang (berdasarkan data ${years[1]}):** ${prodiData.keketatan}

Berdasarkan data di atas, berikan analisis dalam format berikut:

### 1. Analisis Peluang & Tren
Analisis singkat (2-3 kalimat) mengenai tingkat persaingan program studi ini. Jelaskan tren peminat dan daya tampung dalam beberapa tahun terakhir dan apa artinya bagi calon pendaftar tahun ini.

### 2. Rekomendasi Alternatif
Sarankan 2-3 program studi alternatif di PTN lain yang relevan (bidang ilmu sejenis). Prioritaskan yang memiliki peluang lebih tinggi (keketatan di atas 5% jika memungkinkan) atau reputasi baik. Sebutkan nama PTN, nama Prodi, dan alasan singkat (misal: 'Peluang lebih tinggi', 'Fokus riset kuat di bidang X').

### 3. Tips & Strategi Lolos
Berikan 2 tips singkat dan konkret untuk persiapan SNBT bagi calon mahasiswa yang menargetkan prodi ini. Fokus pada subtes yang paling relevan. Contoh: 'Fokus pada subtes Penalaran Matematika karena sangat relevan untuk prodi Teknik.'

Gunakan bahasa yang memotivasi dan mudah dipahami. Format jawaban menggunakan Markdown.
            `;
            
            try {
                const text = await callGeminiAPI(prompt);
                // Basic Markdown to HTML
                let html = text
                    .replace(/### (.*)/g, '<h4 class="font-bold text-md text-slate-800 mt-4 mb-2">$1</h4>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
                aiResponse.innerHTML = html;
            } catch(error) {
                console.error("Gemini API Error:", error);
                aiResponse.innerHTML = `<p class="text-red-500">Maaf, terjadi kesalahan saat menghubungi AI. Silakan coba lagi beberapa saat lagi.</p>`;
            } finally {
                modalLoading.classList.add('hidden');
                modalResult.classList.remove('hidden');
            }
        }
      });
      
      async function callGeminiAPI(prompt) {
          const apiKey = "AIzaSyDopkAQ6qLc6Oz7MsucwRLzraClSP8qsVg"; // API Key is handled by the environment
          const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
          
          const payload = {
              contents: [{ role: "user", parts: [{ text: prompt }] }]
          };

          const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });

          if (!response.ok) {
              throw new Error(`API call failed with status: ${response.status}`);
          }

          const result = await response.json();

          if (result.candidates && result.candidates.length > 0 &&
              result.candidates[0].content && result.candidates[0].content.parts &&
              result.candidates[0].content.parts.length > 0) {
            return result.candidates[0].content.parts[0].text;
          } else {
            console.warn('Unexpected API response structure:', result);
            if (result.promptFeedback && result.promptFeedback.blockReason) {
                throw new Error(`Request blocked: ${result.promptFeedback.blockReason}. Details: ${JSON.stringify(result.promptFeedback.safetyRatings)}`);
            }
            throw new Error("Gagal mendapatkan respons dari AI.");
          }
      }

    });
  </script>
</body>
</html>
